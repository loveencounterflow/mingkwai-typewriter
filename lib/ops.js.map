{
  "version": 3,
  "file": "ops.js",
  "sourceRoot": "..",
  "sources": [
    "src/ops.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "\n### TAINTs\n\n* separate:\n\n  * `focus` (a mechanism used by the browser)\n\n  * ?`select`, `choose`? for the action of selecting one particular candidate\n\n  * ??? for what is called `focusframe` now\n\n  these are three different things and should be called different names.\n\n* accordingly, rename `focusframe` and those `*_focus*` methods that refer to it instead of to browser focus\n\n* use module-global `S`: this code will only ever run a single input instance; where it does use modules\n  that potentially serve several independent consumers, `S` will not be used as argument anyway\n\n* refactor code into (local) modules\n\n###\n\n\n\n############################################################################################################\nCND                       = require 'cnd'\nrpr                       = CND.rpr\nbadge                     = '明快打字机/OPS'\ndebug                     = CND.get_logger 'debug',     badge\nalert                     = CND.get_logger 'alert',     badge\nwhisper                   = CND.get_logger 'whisper',   badge\nwarn                      = CND.get_logger 'warn',      badge\nhelp                      = CND.get_logger 'help',      badge\nurge                      = CND.get_logger 'urge',      badge\ninfo                      = CND.get_logger 'info',      badge\ninspect                   = ( require 'util' ).inspect\n# TRAP                      = require 'mousetrap'\nKEYS                      = require '../lib/keys'\nSTATE                     = require '../lib/state'\nT                         = require '../lib/templates'\nPATH                      = require 'path'\nFS                        = require 'fs'\n#...........................................................................................................\nrequire                   '../lib/exception-handler'\n# require                   '../lib/kana-input'\nrequire                   '../lib/kanji-input'\n#...........................................................................................................\nPD                        = require 'pipedreams'\n{ jr, }                   = CND\n{ after, }                = CND.suspend\ndefer                     = setImmediate\n{ $\n  $async }                = PD\n# XE                        = null\nXE                        = require '../lib/xemitter'\n{ inspect, }              = require 'util'\nxrpr                      = ( x ) -> inspect x, { colors: yes, breakLength: Infinity, maxArrayLength: Infinity, depth: Infinity, }\n#...........................................................................................................\n# `S` is the module-global configuration and editor state object; this will probably factored out into a\n# separate local module to make it `require`able to other modules running in the renderer process:\nS                         = null\n\n#-----------------------------------------------------------------------------------------------------------\nXE.listen_to_all ( key, d ) ->\n  # whisper 'µ99823', key #, jr d\n  v       = d.value\n  { S, }  = v\n  logger  = jQuery '#logger'\n  ( logger.find ':first-child').remove() while logger.children().length > 10\n  message = switch key\n    when '^kblevel' then  ( k for k, toggle of S.kblevels when toggle ).join ', '\n    else                  ( k for k         of d.value                ).join ', '\n  #.........................................................................................................\n  logger.append ( \"<div>#{Date.now()}: #{rpr key}: #{message}</div>\" )\n  console.log 'µ33499', Date.now(), key, d\n  # if ( kblevels = d.value?.S?.kblevels )\n  #   logger.append ( \"<div>#{Date.now()}: kblevels: #{rpr kblevels}</div>\" )\n  logger.scrollTop logger[ 0 ].scrollHeight\n  #.........................................................................................................\n  return null\n\n#-----------------------------------------------------------------------------------------------------------\n@log = ( text ) ->\n  ### TAINT code duplication ###\n  logger = jQuery '#logger'\n  ( logger.find ':first-child').remove() while logger.children().length > 10\n  ### TAINT should escape text (or accept HTML?) ###\n  logger.append ( \"<div>#{Date.now()}: #{text}</div>\" )\n  console.log 'µ33499', Date.now(), text\n  logger.scrollTop logger[ 0 ].scrollHeight\n  return null\n\n\n# #-----------------------------------------------------------------------------------------------------------\n# @on_add_selection = ( uie ) ->\n#   { S, } = uie\n#   debug '44545', 'selected row nr:', S.row_idx + 1\n#   chr = S.rows?[ S.row_idx ]?.glyph\n#   XE.emit 'IME/input/add', { S, row_idx: S.row_idx, chr, }\n#   uie.event.preventDefault()\n#   return null\n\n# #-----------------------------------------------------------------------------------------------------------\n# XE.listen_to 'IME/input/add', @, ( { S, row_idx, chr, } ) ->\n#   debug \"update output area\"\n#   debug \"reset candidates area, input box\"\n#   ### TAINT remove buffer ###\n#   S.buffer.push chr\n#   # ( jQuery '#output-area .inbox' ).text S.buffer.join ''\n#   S.codemirror.editor.replaceSelection chr\n#   ( jQuery '#text-input' ).text ''\n#   return null\n\n#-----------------------------------------------------------------------------------------------------------\n@on_scroll = ( S, event ) =>\n  # if event.originalEvent.deltaY < 0 then  @navigate_vertically S, -1\n  # else                                    @navigate_vertically S, +1\n  if S.ignore_next_scroll_events >= 0\n    S.ignore_next_scroll_events += -1\n    # debug 'scroll', 'discard'\n    return true\n  S.ignore_next_scroll_events = 1\n  delta_px                    = ( S.scroller.scrollTop() - S.scroller_last_top ) / S.candidates_tr_height\n  S.scroller_last_top         = S.scroller.scrollTop()\n  # debug 'scroll', delta_px\n  # CND.dir event\n  # return false if delta_px is 0\n  if delta_px < 0 then  @navigate_vertically S, -1\n  else                  @navigate_vertically S, +1\n  return false;\n\n#-----------------------------------------------------------------------------------------------------------\n@on_wheel = ( S, event ) =>\n  if event.originalEvent.deltaY < 0 then  @navigate_vertically S, -1\n  else                                    @navigate_vertically S, +1\n  return false;\n\n#-----------------------------------------------------------------------------------------------------------\n@on_vertical_navigation = ( uie ) ->\n  switch uie.name\n    when 'up'         then  delta = -1\n    when 'down'       then  delta = +1\n    when 'page-up'    then  delta = -10\n    when 'page-down'  then  delta = +10\n  @navigate_vertically uie.S, delta\n  uie.event.preventDefault()\n  return null\n\n#-----------------------------------------------------------------------------------------------------------\n@navigate_vertically = ( S, delta ) ->\n  new_row_idx       = S.row_idx + delta\n  corrected_row_idx = Math.max 0,                 new_row_idx\n  corrected_row_idx = Math.min S.rows.length - 1, corrected_row_idx\n  #.........................................................................................................\n  XE.emit 'WINDOW/scroll/vertical', {\n    S,\n    from: S.row_idx         + 1,\n    via:  new_row_idx       + 1,\n    to:   corrected_row_idx + 1, }\n  #.........................................................................................................\n  S.row_idx         = corrected_row_idx\n  element           = ( jQuery '#candidates tr' ).eq S.row_idx\n  if element?.offset? and ( element_offset = element.offset() )?\n    delta_px                      = element_offset.top - S.shade_offset_top\n    S.scroller_last_top           = S.scroller.scrollTop() + delta_px\n    S.ignore_next_scroll_events  += +1\n    S.scroller.scrollTop S.scroller_last_top\n    # ( ( jQuery element ).find '.glyph' ).css 'font-size', '125%'\n  return null\n\n# # #-----------------------------------------------------------------------------------------------------------\n# # XE.listen_to 'WINDOW/scroll/vertical', @, ({ S, from, via, to, }) ->\n# #   whisper \"WINDOW/scroll/vertical #{from} -> #{via} -> #{to}\"\n\n#-----------------------------------------------------------------------------------------------------------\nXE.listen_to '^candidates', @, ( d ) ->\n  @focusframe_to_candidates S unless S.focus_is_candidates\n  v       = d.value\n  { S, }  = v\n  rows    = ( ( T.get_flexgrid_html ( idx + 1 ), glyph ) for glyph, idx in v.candidates ).join '\\n'\n  ( jQuery '#candidates-flexgrid div' ).remove()\n  ( jQuery '#candidates-flexgrid'     ).append rows\n  #.........................................................................................................\n  ### TAINT code duplication ###\n  S.glyphboxes = jQuery '#candidates-flexgrid div.glyph'\n  S.glyphboxes.on 'click', ( e ) =>\n    me = jQuery e.target\n    ### TAINT code duplication ###\n    ### TAINT use API to move selection ###\n    S.glyphboxes.removeClass  'cdtsel'\n    me.addClass             'cdtsel'\n    @log \"µ33983-1 #{me.text()} #{jr me.offset()}\"\n  #.........................................................................................................\n  @index_candidates()\n  return null\n\n#-----------------------------------------------------------------------------------------------------------\n@index_candidates = ->\n  ### Add or update each candidate `<div class=glyph> with attributes indicating its left- and right-based\n  column and row numbers, starting from 1. Elements that match `jQuery '[lrow=1]'` are in the first row from\n  the top, while those that match `jQuery '[rrow=1]'` are in the last row from top (first row from the\n  bottom). Likewise, `lcol=1`, `rcol=1` match the leftmost and rightmost elements. These indexes have to be\n  re-calculated after each container resize event, but simplify the code needed to select single and groups\n  of elements. The beauty of the scheme is that we can select e.g. all leftmost elements or all elements\n  in the first row (should the need ever arise). ###\n  ### TAINT code duplication ###\n  S.glyphboxes   ?= jQuery '#candidates-flexgrid div.glyph'\n  lcol            = 0\n  lrow            = 0\n  prv_top         = null\n  candidate_count = S.glyphboxes.length\n  lnr             = 0\n  rnr             = candidate_count + 1\n  rows            = []\n  row             = null\n  #.........................................................................................................\n  @log \"index_candidates() (#{candidate_count})\"\n  #.........................................................................................................\n  for idx in [ 0 ... candidate_count ]\n    glyphbox = S.glyphboxes.eq idx\n    #.......................................................................................................\n    if ( nxt_top = glyphbox.offset().top ) isnt prv_top\n      if row?\n        rows.push row\n        col_count = row.length\n        for candidate, col_idx in row\n          candidate.attr 'rcol', col_count - col_idx\n      #.....................................................................................................\n      row = []\n      prv_top = nxt_top\n      lcol    = 0\n      lrow   += +1\n    #.......................................................................................................\n    row.push glyphbox\n    lnr      += +1\n    rnr      += -1\n    lcol     += +1\n    #.......................................................................................................\n    glyphbox.attr 'lnr',  lnr\n    glyphbox.attr 'rnr',  rnr\n    glyphbox.attr 'lcol', lcol\n    glyphbox.attr 'lrow', lrow\n  #.........................................................................................................\n  rows.push row if row?\n  row_count = rows.length\n  for row, row_idx in rows\n    for candidate in row\n      candidate.attr 'rrow', row_count - row_idx\n  #.........................................................................................................\n  rows.length = 0 ### not strictly needed, just to make de-allocation explicit ###\n  return null\n\n#-----------------------------------------------------------------------------------------------------------\n@select_nxt_candidate     = -> @_select_delta_candidate          +1\n@select_prv_candidate     = -> @_select_delta_candidate          -1\n@select_nxtline_candidate = -> @_select_deltaline_candidate      +1\n@select_prvline_candidate = -> @_select_prv_deltaline_candidate  -1\n\n#-----------------------------------------------------------------------------------------------------------\n@_select_delta_candidate = ( delta ) ->\n  ### Select delta-next or -previous candidate; `+1` moves to immediately following candidate, `-1` to\n  immediately preceding one; higher `delta` skips that many gaps. Returns number of candidates moved, so\n  returns zero if there were no candidates, or was already on first (or last) when moving backwards (or\n  forwards). ###\n  R                   = 0\n  return R if delta is 0\n  prv_cdtsel          = jQuery '.cdtsel'\n  #.........................................................................................................\n  if prv_cdtsel.length is 0\n    @log \"_select_delta_candidate: no candidate selected\"\n    return R\n  #.........................................................................................................\n  glyphboxes          = jQuery '#candidates-flexgrid div.glyph'\n  method_name         = if delta > 0 then 'next' else 'prev'\n  delta               = Math.abs delta\n  prv_cdtsel[ 0 ].scrollIntoViewIfNeeded()\n  #.........................................................................................................\n  while delta > 0\n    nxt_cdtsel          = prv_cdtsel[ method_name ]()\n    break if nxt_cdtsel.length is 0\n    R                  += +1\n    glyphboxes.removeClass  'cdtsel'\n    nxt_cdtsel.addClass     'cdtsel'\n    nxt_cdtsel[ 0 ].scrollIntoViewIfNeeded()\n    delta              += -1\n  #.........................................................................................................\n  return R\n\n#-----------------------------------------------------------------------------------------------------------\n@_select_prv_deltaline_candidate = ( delta ) ->\n  await @_select_deltaline_candidate delta\n  await @_select_first_candidate_in_line()\n\n#-----------------------------------------------------------------------------------------------------------\n@_select_first_candidate_in_line = ->\n\n#-----------------------------------------------------------------------------------------------------------\n@_select_deltaline_candidate = ( delta ) ->\n  return new Promise ( resolve ) =>\n    @log \"µ77722 _select_deltaline_candidate #{delta}\"\n    return resolve() if S.selecting_candidate\n    return resolve() if delta is 0\n    S.selecting_candidate = true\n    prv_cdtsel            = jQuery '.cdtsel'\n    #.......................................................................................................\n    if prv_cdtsel.length is 0\n      S.selecting_candidate = false\n      @log \"µ33634 _select_deltaline_candidate: no candidate selected\"\n      return resolve()\n    #.......................................................................................................\n    sub_delta             = Math.sign delta\n    delta                 = Math.abs  delta\n    prv_top               = prv_cdtsel.offset().top\n    dts                   = 0\n    #.......................................................................................................\n    try_next_candidate  = =>\n      #.....................................................................................................\n      if ( @_select_delta_candidate sub_delta ) is 0\n        S.selecting_candidate = false\n        return resolve()\n      #.....................................................................................................\n      nxt_cdtsel  = jQuery '.cdtsel'\n      if nxt_cdtsel.length is 0 ### should never happen ###\n        S.selecting_candidate = false\n        @log \"µ33679 _select_deltaline_candidate: no candidate selected\"\n        return resolve()\n      #.....................................................................................................\n      if ( Math.abs nxt_cdtsel.offset().top - prv_top ) < 2\n        defer try_next_candidate\n      else\n        S.selecting_candidate = false\n      return resolve()\n    #.......................................................................................................\n    defer try_next_candidate\n    return resolve()\n\n#-----------------------------------------------------------------------------------------------------------\nXE.listen_to '^load-documents', @, ( d ) ->\n  ### Will be used to restore previous state, open new documents; for now, just opens the default file. ###\n  ### TAINT auto-create file when not present ###\n  file_path = PATH.resolve PATH.join __dirname, '../.cache/default.md'\n  d.value.S.codemirror.editor.doc.setValue FS.readFileSync file_path, { encoding: 'utf-8', }\n  return null\n\n#-----------------------------------------------------------------------------------------------------------\n### TAINT use proper keybinding API to define key bindings ###\nXE.listen_to '^keyboard', @, ( d ) ->\n  { key, S, } = d.value\n  if ( key.name is 'ctrl+s' ) and ( key.move is 'up' )\n    XE.emit PD.new_event '^save-document', { S, }\n  return null\n\n#-----------------------------------------------------------------------------------------------------------\nXE.listen_to '^save-document', @, ( d ) ->\n  ### Will be used to save active document; currently just saves default file. ###\n  file_path = PATH.resolve PATH.join __dirname, '../.cache/default.md'\n  @log \"saving document to #{rpr file_path}\"\n  FS.writeFileSync file_path, d.value.S.codemirror.editor.doc.getValue()\n  return null\n\n#-----------------------------------------------------------------------------------------------------------\n@focusframe_to_editor = ( S ) ->\n  @_focusframe_to S, 'leftbar'\n  ### TAINT use method, must be possible to remap ###\n  S.focus_is_candidates = false\n  # S.kblevels.shift      = false\n@focusframe_to_candidates = ( S ) ->\n  @_focusframe_to S, 'rightbar'\n  ### TAINT use method, must be possible to remap ###\n  S.focus_is_candidates = true\n  # S.kblevels.shift      = false\n@focusframe_to_logger = ( S ) ->\n  @_focusframe_to S, '#logger'\n  ### TAINT use method, must be possible to remap ###\n  S.focus_is_candidates = false\n  # S.kblevels.shift      = false\n\n#-----------------------------------------------------------------------------------------------------------\n@_focusframe_to = ( S, target ) ->\n  # target      = jQuery( document.activeElement )\n  target      = jQuery target if CND.isa_text target\n  ff          = jQuery 'focusframe'\n  return if target.length < 1\n  # ff.offset     target.offset()\n  # ff.width      target.width()\n  # ff.height     target.height()\n  tgto        = target.offset()\n  return unless tgto?\n  left    = tgto.left       - 1\n  top     = tgto.top        - 1\n  width   = target.width()  + 2\n  height  = target.height() + 2\n  ff.animate { left, top, width, height, }, 100\n  return null\n\n#-----------------------------------------------------------------------------------------------------------\n### TAINT use proper keybinding API to define key bindings ###\nXE.listen_to '^kblevel', @, ( d ) ->\n  ### map kblevel 'shift' to manual editor/candidates focus selection ###\n  v       = d.value\n  { S, }  = v\n  # debug 'µ87444', S.kblevels.shift\n  if ( S.focus_is_candidates = S.kblevels.shift ) then  @focusframe_to_candidates S\n  else                                                  @focusframe_to_editor     S\n  ### TAINT consider to re-set focus after mouse clicks to elsewhere in GUI ###\n  ### Make browser focus always stay on editor: ###\n  return null\n\n#-----------------------------------------------------------------------------------------------------------\n@always_focus_editor = ->\n  @always_focus_editor = -> ### do not add any more handlers with this method after first call ###\n  ( jQuery 'div.CodeMirror-code' ).on 'blur', -> @focus()\n  ( jQuery 'div.CodeMirror-code' ).focus()\n  return null\n\n# #-----------------------------------------------------------------------------------------------------------\n# ### TAINT use proper keybinding API to define key bindings ###\n# XE.listen_to '^keyboard', @, ( d ) ->\n#   { key, S, } = d.value\n#   return unless ( key.move is 'up' )\n#   switch key.name\n#     when 'left'     then  @focusframe_to_editor     S\n#     when 'right'    then  @focusframe_to_candidates S\n#     when 'up'       then  @focusframe_to_editor     S\n#     when 'down'     then  @focusframe_to_logger     S\n#   return null\n\n\n\n###\n#-----------------------------------------------------------------------------------------------------------\n@_handle_cm_keymap_move = ( cm, editor_method, candidates_method ) ->\n  if S.focus_is_candidates then candidates_method.apply @,                    cm\n  else                          editor_method.apply     CodeMirror.commands,  cm\n  return null\n###\n\n#-----------------------------------------------------------------------------------------------------------\n@cm_keymap_move_left = ( cm ) ->\n  ### TAINT is there a way not to name default command explicitly? ###\n  if S.focus_is_candidates then @select_prv_candidate()\n  else                          CodeMirror.commands.goCharLeft cm\n  return null\n\n#-----------------------------------------------------------------------------------------------------------\n@cm_keymap_move_right = ( cm ) ->\n  if S.focus_is_candidates then @select_nxt_candidate()\n  else                          CodeMirror.commands.goCharRight cm\n  return null\n\n#-----------------------------------------------------------------------------------------------------------\n@cm_keymap_move_up = ( cm ) ->\n  if S.focus_is_candidates then debug 'µ77644-2', \"cursor movement goes to candidates\"\n  else                          CodeMirror.commands.goLineUp cm\n  return null\n\n#-----------------------------------------------------------------------------------------------------------\n@cm_keymap_move_down = ( cm ) ->\n  if S.focus_is_candidates then debug 'µ77644-2', \"cursor movement goes to candidates\"\n  else                          CodeMirror.commands.goLineDown cm\n  return null\n\n#-----------------------------------------------------------------------------------------------------------\n@cm_keymap_move_tab = ( cm ) ->\n  if S.focus_is_candidates then @select_nxtline_candidate()\n  else                          CodeMirror.commands.defaultTab cm\n  return null\n\n#-----------------------------------------------------------------------------------------------------------\n@cm_keymap_move_shifttab = ( cm ) ->\n  if S.focus_is_candidates then @select_prvline_candidate()\n  else                          CodeMirror.commands.indentLess cm\n  return null\n\n\n#-----------------------------------------------------------------------------------------------------------\n@init_cm_keymap = ( S ) ->\n  mktw_keymap =\n    'Left':       ( cm  ) => @cm_keymap_move_left     cm\n    'Right':      ( cm  ) => @cm_keymap_move_right    cm\n    'Up':         ( cm  ) => @cm_keymap_move_up       cm\n    'Down':       ( cm  ) => @cm_keymap_move_down     cm\n    'Tab':        ( cm  ) => @cm_keymap_move_tab      cm\n    'Shift-Tab':  ( cm  ) => @cm_keymap_move_shifttab cm\n  #.........................................................................................................\n  S.codemirror.editor.addKeyMap mktw_keymap\n  return null\n\n#-----------------------------------------------------------------------------------------------------------\n@init = ->\n  # { remote, }               = require 'electron'\n  # XE                        = remote.require './xemitter'\n  #.........................................................................................................\n  ### Instantiate state, add important UI elements ###\n  S                     = STATE.new()\n  S.candidates          =\n    jq:           jQuery '#candidates'\n    selected:\n      id:         null\n  S.focus_is_candidates = false\n  #.........................................................................................................\n  # ### Register key and mouse events ###\n  # S.scroller.on 'wheel',                ( event ) => @on_wheel                S, event\n  # S.scroller.on 'scroll',               ( event ) => @on_scroll               S, event\n  # S.input.on 'input',                   ( event ) => @on_input                S, event\n  # ### use event for this? ###\n  # S.scroller_last_top = S.scroller.scrollTop()\n  #.........................................................................................................\n  ### Initialize CodeMirror ###\n  S.codemirror.editor = CodeMirror.fromTextArea ( jQuery '#codemirror' )[ 0 ], S.codemirror.settings\n  S.codemirror.editor.setSize null, '100%'\n  S.codemirror.editor.on 'inputRead', ( me, change ) -> XE.emit PD.new_event '^raw-input', { S, change, }\n  S.codemirror.editor.on 'change', ( me, change ) ->\n    ### TAINT when inserting results, will there be a change event? ###\n    return null unless change.origin is '+delete'\n    XE.emit PD.new_event '^raw-input', { S, change, }\n  @always_focus_editor()\n  #.........................................................................................................\n  S.codemirror.editor.on 'beforeChange',    ( me, change      ) -> whisper 'µ66653', 'beforeChange',  jr change\n  S.codemirror.editor.on 'change',          ( me, change      ) -> whisper 'µ66653', 'change',        jr change\n  # S.codemirror.editor.on 'changes',         ( me, changes     ) -> whisper 'µ66653', 'changes',       jr changes\n  # S.codemirror.editor.on 'cursorActivity',  ( me              ) -> whisper 'µ66653', 'cursorActivity'\n  # S.codemirror.editor.on 'keyHandled',      ( me, name, event ) -> whisper 'µ66653', 'keyHandled',    jr name\n  # S.codemirror.editor.on 'inputRead',       ( me, change      ) -> whisper 'µ66653', 'inputRead',     jr change\n  #.........................................................................................................\n  ### Register key and mouse events ###\n  KEYS.syphon_key_and_mouse_events S, jQuery 'html'\n  # KEYS.register 'axis', 'vertical',     ( uie )   => @on_vertical_navigation  uie\n  # KEYS.register 'slot', 'Enter',        ( uie )   => @on_add_selection        uie\n  XE.emit PD.new_event '^load-documents', { S, }\n  @focusframe_to_editor S\n  @init_cm_keymap S\n  #.........................................................................................................\n  ### Detect resizing events: ###\n  ### TAINT won't work when panes are shifted (probably) ###\n  ( jQuery window ).on 'resize', =>\n    debug \"resize window\"\n    @index_candidates()\n    return null\n  return null\n\n#-----------------------------------------------------------------------------------------------------------\njQuery init.bind @\n\n\n###\ncm.findPosH(start: {line, ch}, amount: integer, unit: string, visually: boolean) → {line, ch, ?hitSide: boolean}\ncm.findPosV(start: {line, ch}, amount: integer, unit: string) → {line, ch, ?hitSide: boolean}\ncm.findWordAt(pos: {line, ch}) → {anchor: {line, ch}, head: {line, ch}}\ncm.hasFocus() → boolean\n\ndoc.addSelection        = (anchor: {line, ch}, ?head: {line, ch})\ndoc.changeGeneration    = (?closeEvent: boolean) → integer\ndoc.eachLine            = (f: (line: LineHandle))\ndoc.eachLine            = (start: integer, end: integer, f: (line: LineHandle))\ndoc.extendSelection     = (from: {line, ch}, ?to: {line, ch}, ?options: object)\ndoc.extendSelections    = (heads: array<{line, ch}>, ?options: object)\ndoc.extendSelectionsBy  = (f: function(range: {anchor, head}) → {line, ch}), ?options: object)\ndoc.firstLine           = () → integer\ndoc.getCursor           = (?start: string) → {line, ch}\ndoc.getExtending        = () → boolean\ndoc.getLine             = (n: integer) → string\ndoc.getLineHandle       = (num: integer) → LineHandle\ndoc.getLineNumber       = (handle: LineHandle) → integer\ndoc.getRange            = (from: {line, ch}, to: {line, ch}, ?separator: string) → string\ndoc.getSelection        = (?lineSep: string) → string\ndoc.getSelections       = (?lineSep: string) → array<string>\ndoc.getValue            = (?separator: string) → string\ndoc.isClean             = (?generation: integer) → boolean\ndoc.lastLine            = () → integer\ndoc.lineCount           = () → integer\ndoc.listSelections      = () → array<{anchor, head}>\ndoc.markClean           = ()\ndoc.replaceRange        = (replacement: string, from: {line, ch}, to: {line, ch}, ?origin: string)\ndoc.replaceSelection    = (replacement: string, ?select: string)\ndoc.replaceSelections   = (replacements: array<string>, ?select: string)\ndoc.setCursor           = (pos: {line, ch}|number, ?ch: number, ?options: object)\ndoc.setExtending        = (value: boolean)\ndoc.setSelection        = (anchor: {line, ch}, ?head: {line, ch}, ?options: object)\ndoc.setSelections       = (ranges: array<{anchor, head}>, ?primary: integer, ?options: object)\ndoc.setValue            = (content: string)\ndoc.somethingSelected   = () → boolean\n###\n\n\n\n\n"
  ]
}